!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("react"),require("kefir"),require("infestines")):"function"==typeof define&&define.amd?define(["exports","react","kefir","infestines"],r):r(e.karet={},e.React,e.Kefir,e.I)}(this,function(e,r,n,t){"use strict";function i(e,r){e.at=0,e.doSubscribe(r),e.at=1}function a(e,r,n){if(j(e))return n[r.at++];if(t.isArray(e)){for(var i=e,s=0,l=e.length;s<l;++s){var u=e[s],o=u;j(u)?o=n[r.at++]:t.isArray(u)&&(o=a(u,r,n)),o!==u&&(i===e&&(i=e.slice(0)),i[s]=o)}return i}return e}function s(e,r,n){var t=null;for(var i in e){var a=e[i];if(j(a)){if(!t){t={};for(var s in e){if(s===i)break;t[s]=e[s]}}t[i]=n[r.at++]}else t&&(t[i]=a)}return t||e}function l(e,r){var n=e.props,t=null,i=null,l=null;e.at=0;for(var u in n){var o=n[u];g===u?l=a(o,e,r):"$$type"===u?t=n[u]:U===u?(i=i||{}).ref=j(o)?r[e.at++]:o:j(o)?(i=i||{})[u]=r[e.at++]:k===u?(i=i||{}).style=s(o,e,r):(i=i||{})[u]=o}return l instanceof Array?$.apply(null,[t,i].concat(l)):null!==l?$(t,i,l):$(t,i)}function u(e,r,n){for(var i=0,a=e.length;i<a;++i){var s=e[i];j(s)?n(r,s):t.isArray(s)&&u(s,r,n)}}function o(e,r,n){for(var i in e){var a=e[i];if(j(a))n(r,a);else if(g===i)t.isArray(a)&&u(a,r,n);else if(k===i)for(var s in a){var l=a[s];j(l)&&n(r,l)}}}function f(e){e.values+=1}function c(e,r){r.offAny(e)}function h(e,r){var n=e.pop();n&&r.offAny(n)}function v(e,r){r.onAny(e)}function d(e,r){var n=function r(n){for(var t=e.handlers,i=0;t[i]!==r;)++i;switch(n.type){case m:var a=n.value,s=e.values;s[i]!==a&&(s[i]=a,e.at&&e.forceUpdate());break;case A:throw n.value;default:t[i]=null;var l=t.length;if(l!==e.values.length)return;for(var u=0;u<l;++u)if(t[u])return;e.handlers=null}};e.handlers.push(n),r.onAny(n)}function p(e,r){for(var n=r.length;e<n;++e){var i=r[e];if(j(i)||t.isArray(i)&&p(0,i))return!0}return!1}function y(e){for(var r in e){var n=e[r];if(j(n))return!0;if(g===r){if(t.isArray(n)&&p(0,n))return!0}else if(k===r)for(var i in n)if(j(n[i]))return!0}return!1}function b(e,r){var n={$$type:e};for(var t in r){var i=r[t];"ref"===t?n[U]=i:w!==t&&(n[t]=i)}return n}var m="value",A="error",k="style",g="children",w="karet-lift",U="$$ref",$=r.createElement,W=r.Component,j=function(e){return e instanceof n.Observable},S=t.inherit(function(e){W.call(this,e),this.at=0},W,{componentWillReceiveProps:function(e){this.componentWillUnmount(),i(this,e)},componentWillMount:function(){i(this,this.props)}}),q=t.inherit(function(e){S.call(this,e),this.callback=this.rendered=null},S,{componentWillUnmount:function(){var e=this.callback;e&&this.props.observable.offAny(e)},doSubscribe:function(e){var r=this,n=e.observable;if(j(n)){var t=function(e){switch(e.type){case m:r.rendered=e.value||null,r.at&&r.forceUpdate();break;case A:throw e.value;case"end":r.callback=null}};this.callback=t,n.onAny(t)}else this.rendered=n||null;this.at=1},render:function(){return this.rendered}}),x=t.inherit(function(e){S.call(this,e),this.values=this,this.handlers=null},S,{componentWillUnmount:function(){var e=this.handlers;e instanceof Function?o(this.props,e,c):e&&o(this.props,e.reverse(),h)},doSubscribe:function(e){var r=this;this.values=0,o(e,this,f);var n=this.values;switch(n){case 0:this.values=t.array0;break;case 1:this.values=this,o(e,this.handlers=function(e){switch(e.type){case m:var n=e.value;r.values!==n&&(r.values=n,r.at&&r.forceUpdate());break;case A:throw e.value;default:r.values=[r.values],r.handlers=null}},v);break;default:this.values=Array(n).fill(this),this.handlers=[],o(e,this,d)}},render:function(){if(this.handlers instanceof Function){var e=this.values;return e===this?null:l(this,[e])}for(var r=this.values,n=0,t=r.length;n<t;++n)if(r[n]===this)return null;return l(this,r)}});e.fromKefir=function(e){return $(q,{observable:e})},e.createElement=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];var i=r[0],a=r[1]||t.object0;return(t.isString(i)||a[w])&&(p(2,r)||y(a)?(r[1]=b(i,a),r[0]=x):a[w]&&(r[1]=t.dissocPartialU(w,a)||t.object0)),$.apply(void 0,r)},e.fromClass=function(e){return function(r){return $(x,b(e,r))}},Object.defineProperty(e,"__esModule",{value:!0})});
