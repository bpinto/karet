!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("react"),require("kefir"),require("infestines")):"function"==typeof define&&define.amd?define(["exports","react","kefir","infestines"],r):r(e.karet={},e.React,e.Kefir,e.I)}(this,function(e,r,n,t){"use strict";function i(e,r){e.at=0,e.doSubscribe(r),e.at=1}function a(e,r,n){if(F(e))return n[r.at++];if(t.isArray(e)){for(var i=e,s=0,l=e.length;s<l;++s){var u=e[s],o=u;F(u)?o=n[r.at++]:t.isArray(u)&&(o=a(u,r,n)),o!==u&&(i===e&&(i=e.slice(0)),i[s]=o)}return i}return e}function s(e,r,n){var t=null;for(var i in e){var a=e[i];if(F(a)){if(!t)for(var s in t={},e){if(s===i)break;t[s]=e[s]}t[i]=n[r.at++]}else t&&(t[i]=a)}return t||e}function l(e,r){var n=e.props,t=null,i=null,l=null;for(var u in e.at=0,n){var o=n[u];k===u?l=a(o,e,r):"$$type"===u?t=n[u]:w===u?(i=i||{}).ref=F(o)?r[e.at++]:o:F(o)?(i=i||{})[u]=r[e.at++]:A===u?(i=i||{}).style=s(o,e,r):(i=i||{})[u]=o}return l instanceof Array?U.apply(null,[t,i].concat(l)):null!==l?U(t,i,l):U(t,i)}function u(e,r,n){for(var i=0,a=e.length;i<a;++i){var s=e[i];F(s)?n(r,s):t.isArray(s)&&u(s,r,n)}}function o(e,r,n){for(var i in e){var a=e[i];if(F(a))n(r,a);else if(k===i)t.isArray(a)&&u(a,r,n);else if(A===i)for(var s in a){var l=a[s];F(l)&&n(r,l)}}}function f(e){e.values+=1}function c(e,r){r.offAny(e)}function h(e,r){var n=e.pop();n&&r.offAny(n)}function v(e,r){r.onAny(e)}function d(e,r){var n=function r(n){for(var t=e.handlers,i=0;t[i]!==r;)++i;switch(n.type){case b:var a=n.value,s=e.values;s[i]!==a&&(s[i]=a,e.at&&e.forceUpdate());break;case m:throw n.value;default:t[i]=null;var l=t.length;if(l!==e.values.length)return;for(var u=0;u<l;++u)if(t[u])return;e.handlers=null}};e.handlers.push(n),r.onAny(n)}function p(e,r){for(var n=r.length;e<n;++e){var i=r[e];if(F(i)||t.isArray(i)&&p(0,i))return!0}return!1}function y(e,r){var n={$$type:e};for(var t in r){var i=r[t];"ref"===t?n[w]=i:g!==t&&(n[t]=i)}return n}var b="value",m="error",A="style",k="children",g="karet-lift",w="$$ref",U=r.createElement,$=r.Component,F=function(e){return e instanceof n.Observable},W=t.inherit(function(e){$.call(this,e),this.at=0},$,{componentWillReceiveProps:function(e){this.componentWillUnmount(),i(this,e)},componentWillMount:function(){i(this,this.props)}}),j=t.inherit(function(e){W.call(this,e),this.callback=this.rendered=null},W,{componentWillUnmount:function(){var e=this.callback;e&&this.props.observable.offAny(e)},doSubscribe:function(e){var r=this,n=e.observable;if(F(n)){var t=function(e){switch(e.type){case b:r.rendered=e.value||null,r.at&&r.forceUpdate();break;case m:throw e.value;case"end":r.callback=null}};this.callback=t,n.onAny(t)}else this.rendered=n||null;this.at=1},render:function(){return this.rendered}}),S=t.id(function(e){return U(j,{observable:e})}),q=t.inherit(function(e){W.call(this,e),this.values=this,this.handlers=null},W,{componentWillUnmount:function(){var e=this.handlers;e instanceof Function?o(this.props,e,c):e&&o(this.props,e.reverse(),h)},doSubscribe:function(e){var r=this;this.values=0,o(e,this,f);var n=this.values;switch(n){case 0:this.values=t.array0;break;case 1:this.values=this,o(e,this.handlers=function(e){switch(e.type){case b:var n=e.value;r.values!==n&&(r.values=n,r.at&&r.forceUpdate());break;case m:throw e.value;default:r.values=[r.values],r.handlers=null}},v);break;default:this.values=Array(n).fill(this),this.handlers=[],o(e,this,d)}},render:function(){if(this.handlers instanceof Function){var e=this.values;return e===this?null:l(this,[e])}for(var r=this.values,n=0,t=r.length;n<t;++n)if(r[n]===this)return null;return l(this,r)}});e.Fragment=r.Fragment,e.fromKefir=S,e.createElement=function(){for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];var a=n[0],s=n[1]||t.object0;return(t.isString(a)||r.Fragment===a||s[g])&&(p(2,n)||function(e){for(var r in e){var n=e[r];if(F(n))return!0;if(k===r){if(t.isArray(n)&&p(0,n))return!0}else if(A===r)for(var i in n)if(F(n[i]))return!0}return!1}(s)?(n[1]=y(a,s),n[0]=q):s[g]&&(n[1]=t.dissocPartialU(g,s)||t.object0)),U.apply(void 0,n)},e.fromClass=function(e){return function(r){return U(q,y(e,r))}},Object.defineProperty(e,"__esModule",{value:!0})});
